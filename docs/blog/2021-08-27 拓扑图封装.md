

# 拓扑图创新

随着业务的迅速发展，以前控制器中使用`D3.js`实现的拓扑图功能渐渐地不能满足需求：

1. 代码组织混乱，各功能未有序解耦，维护困难。
2. 未插件化，不能供多个项目使用。
3. `D3.js`使用`svg`来实现，在数据量大时需要生成数量庞大的`dom`结构。

因此，拓扑图急需一次大的升级。



## 插件选型

市面上有不少拓扑图插件，例如：

### 1. AntV G6

简介：G6 是一个图可视化引擎。它提供了图的绘制、布局、分析、交互、动画等图可视化的基础能力。
背景：蚂蚁金服 AntV、国产
官网：https://antv.vision/zh
示例：https://github.com/wenyuan/cceditor

- 优点
  - 开源免费
  - 上手简单，可扩展性强
  - 功能丰富，支持各种自定义操作
  - 由蚂蚁金服 AntV 团队开发，从维护性和生态圈角度考虑相对有保障
  - 支持自动布局（早期借助 d3-force 实现，后期已经被内部支持）
- 缺点
  - 有时候文档和版本会脱节（可以理解，问题不大）
- 建议
  - 大厂团队开发维护，后期有保障，大小项目都可以使用
  - 可以学习里面的一些编程思想和技巧



### 2. D3

只提供画图能力，画什么需要自己实现。



### 3. ECharts

简介：ECharts 关系图。
背景：百度、国产
官网：https://www.echartsjs.com/zh/index.html

- 优点
  - 上手非常简单
  - 文档齐全
- 缺点
  - 扩展性弱（毕竟不是专做图编辑器的，关系图只是 ECharts 中的一项）
- 建议
  - 可以用在定制化的需求中，不需要拖拉拽等功能



### 选型总结

除了上面提到的，还有一些国内外个人开发的插件，但普遍存在维护无保障、文档不齐全等问题。

另外D3之前就在用，存在的问题上面也讲过了。

Echarts拓展性不强，无法适应多变的需求。

加上深信服已经有基于`G6.js`封装了插件，可以在其基础上快速实现功能，于是最终选定使用`G6`进行开发。



## 功能实现

### 架构图

![](D:\Users\User\Desktop\vuepress-blog\docs\blog\images\拓扑图架构.png)

### 树形拓扑图

项目的树形需求主要有几个难点：

1. 需要不同父集的子集间能相互连接
2. 存在不在树结构里的元素
3. 存在域外拓扑，即树拓扑中存在子树拓扑



`G6`原生支持的树形拓扑十分死板，只能展示单纯的树形结构。

本插件通过**自定义数据结构，调用树形算法生成布局**，并转换成`G6`普通图的数据结构，来实现最大化地自定义效果，完美实现需求。



### 自定义图形、事件

根据`G6`的自定义写法，按图形、事件、样式等分好文件夹进行编码。



#### 连线

可根据传入数据，自动显示传输速率、繁忙度、连接方式等信息。



#### 网络设备

根据数据，自动显示网络设备如：控制器、接入点、盒式交换机、框式交换机等。



#### 事件系统

自定义了一系列事件，统一在图实例发送接收，方便外部使用。



### 文档

一个大型的项目，不能缺少了文档。

这里使用`VuePress`作为静态网站生成器，可快速实现预览编写的`.md`格式文档。



### 国际化

可在初始化时拓扑图配置时传入语言类型来控制文字显示。



### mock数据

可配置化的生成指定层级、数量的假数据，方便测试及展示。



### 内部工具

#### 自定义console

可自定义console打印的样式

#### math

内置了许多三角函数等数学公式，可方便的使用。



### 拓展原型方法

对`G6.js`的原型方法进行拓展、补充。



#### minimap

`G6`有提供两种缩略图，`minimap`和`imageMinimap`。

区别就是`minimap`是根据graph再用canvas画一次，而`imageminimap`是将我们自己给的图片显示出来（但是需要自己监听变化并给出图片）。

可想而知，在大量数据的情况下，双倍渲染canvas肯定消耗更大的性能。

本插件通过修改`imageminimap`，实现了自动监听graph变化，同时生成图片并渲染到缩略图上。



### 打包

使用`webpack5`进行打包



#### 开发环境

已内置两套开发环境（普通html和vue）。

通过`npm run dev`即可启动开发环境，自动监听样例代码和拓扑图插件代码变化，热更新页面。



#### 生成环境

通过`npm run build`将文件打包成umd格式，发布到内部npm上即可使用es模块化方式引入。

普通html项目可直接引入js文件。





## 插件系统

所有插件均配置化，可传入配置进行开关、重写。



### 数据工具栏

#### 刷新

自定义数据刷新时间。



#### 选取方式

切换单选和框选数据。



#### 撤销

即上一步。



#### 导出

将拓扑图以图片形式导出。



#### 搜索

通过关键字搜索并高亮相关数据。



### 视图工具栏

对图进行放大、缩小、自适应、缩略图、全屏等操作。



### tooltip

鼠标悬浮提示



### 命令系统

操作动作都写入命令系统，在html上添加命令名即可实现动作。

并可配置命令快捷键。



### 图例

设备图片示例，可动态传入数据进行显示。



### 右键菜单

针对不同设备，显示不同菜单。



## 扩展性

插件、设备样式等均已配置化，可传入数据进行重写，十分方便的完成换肤、拓展等自定义需求。



## 兼容性

现代浏览器完美兼容。

ie10环境，内部使用polyfill兼容。